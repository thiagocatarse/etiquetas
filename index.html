<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shipping Label Generator</title>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: auto; }
        h1 { text-align: center; }
        #file-input { margin: 20px 0; }
        #generate-btn { display: block; margin: 20px auto; padding: 10px 20px; }
        #status { text-align: center; color: #666; font-style: italic; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Shipping Label Generator</h1>
        <input type="file" id="file-input" accept=".csv">
        <button id="generate-btn">Generate Labels</button>
        <p id="status"></p>
    </div>

    <script>
    function loadScript(url, callback) {
        var script = document.createElement('script');
        script.type = 'text/javascript';
        script.src = url;
        script.onload = callback;
        document.head.appendChild(script);
    }

    loadScript('https://unpkg.com/papaparse@latest/papaparse.min.js', function() {
        loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js', initApp);
    });

    function initApp() {
        const fileInput = document.getElementById('file-input');
        const generateBtn = document.getElementById('generate-btn');
        const statusElement = document.getElementById('status');

        let processedData = null;
        let inactivityTimer;
        const INACTIVITY_TIMEOUT = 5 * 60 * 1000; // 5 minutes

        generateBtn.addEventListener('click', generateLabels);

        // Set up event listeners for automatic clearing
        window.addEventListener('beforeunload', clearData);
        document.addEventListener('mousemove', resetInactivityTimer);
        document.addEventListener('keypress', resetInactivityTimer);

        function generateLabels() {
            const file = fileInput.files[0];
            if (!file) {
                setStatus('Please select a CSV file first.', 'error');
                return;
            }

            Papa.parse(file, {
                complete: function(results) {
                    if (validateCSV(results.data)) {
                        processedData = processCSV(results.data);
                        generatePDF(processedData);
                        // Clear data after PDF generation
                        setTimeout(() => {
                            clearData();
                            setStatus('Labels generated and data cleared.', 'success');
                        }, 1000);
                    } else {
                        setStatus('Invalid CSV format. Please check your file and try again.', 'error');
                    }
                }
            });
        }

        function validateCSV(data) {
            if (data.length < 2) return false; // At least header row and one data row

            const requiredHeaders = ['Nome completo', 'Rua', 'Número', 'Complemento', 'Bairro', 'Cidade', 'Estado', 'País', 'CEP', 'Telefone', 'Envio', 'Título da recompensa'];
            const headers = data[0];

            return requiredHeaders.every(header => headers.includes(header));
        }

        function processCSV(data) {
            const headers = data[0];
            return data.slice(1).map(row => {
                const backer = {};
                headers.forEach((header, index) => {
                    backer[header] = row[index] ? row[index].trim() : '';
                });
                backer.address = `${backer['Rua']} ${backer['Número']} ${backer['Complemento']} - ${backer['Bairro']} - ${backer['Cidade']} - ${backer['Estado']} - ${backer['País']} - CEP ${backer['CEP']}`;
                return backer;
            });
        }

        function generatePDF(backers) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const pageWidth = 210;
            const pageHeight = 297;
            const marginTop = 9;
            const marginHorizontal = 4.7;
            const labelHeight = 55.8;
            const labelWidth = 99;
            const labelsPerLine = 2;
            const linesPerPage = 5;

            backers.forEach((backer, i) => {
                if (i > 0 && i % (labelsPerLine * linesPerPage) === 0) {
                    doc.addPage();
                }

                const row = Math.floor((i % (labelsPerLine * linesPerPage)) / labelsPerLine);
                const col = i % labelsPerLine;

                const x = marginHorizontal + col * labelWidth;
                const y = marginTop + row * labelHeight;

                doc.rect(x, y, labelWidth, labelHeight);

                doc.setFontSize(8);
                doc.text(`Nome: ${backer['Nome completo']}`, x + 2, y + 5);

                const addressLines = splitText(backer.address, 40);
                addressLines.forEach((line, j) => {
                    doc.text(line, x + 2, y + 10 + j * 4);
                });

                doc.text(`Telefone: ${backer['Telefone']}`, x + 2, y + labelHeight - 15);
                doc.text(`Envio: ${backer['Envio']}`, x + 2, y + labelHeight - 10);
                doc.text(`Recompensa: ${backer['Título da recompensa']}`, x + 2, y + labelHeight - 5);
            });

            doc.save('shipping_labels.pdf');
        }

        function splitText(text, maxChars) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = '';

            words.forEach(word => {
                if ((currentLine + word).length <= maxChars) {
                    currentLine += (currentLine ? ' ' : '') + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            });

            if (currentLine) {
                lines.push(currentLine);
            }

            return lines;
        }

        function clearData() {
            fileInput.value = '';
            processedData = null;
            // Force garbage collection for browsers that support it
            if (window.gc) {
                window.gc();
            }
            console.log('Data has been cleared from memory.');
        }

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                clearData();
                setStatus('Data cleared due to inactivity.', 'info');
            }, INACTIVITY_TIMEOUT);
        }

        function setStatus(message, type) {
            statusElement.textContent = message;
            statusElement.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : '#666';
        }

        // Initial setup of inactivity timer
        resetInactivityTimer();
    }
    </script>
</body>
</html>
